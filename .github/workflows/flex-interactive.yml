name: Flex Interactive CI

on:
  # Trigger the workflow on push or pull request,
  # but only for the main branch
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'flex/**'
      - 'coordinator/gscoordinator/flex/**'
      - 'python/graphscope/gsctl/**'
      - '.github/workflows/flex-interactive.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'flex/**'
      - 'coordinator/gscoordinator/flex/**'
      - 'python/graphscope/gsctl/**'
      - '.github/workflows/flex-interactive.yml'

concurrency:
  group: ${{ github.repository }}-${{ github.event.number || github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  api-test:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Add envs to GITHUB_ENV
      run: |
        short_sha=$(git rev-parse --short HEAD)
        echo "SHORT_SHA=${short_sha}" >> $GITHUB_ENV

    - name: Build Image
      run: |
        cd ${GITHUB_WORKSPACE}
        python3 -m pip install --upgrade pip && python3 -m pip install click
        python3 ./gsctl.py flexbuild interactive --app docker

    - name: Build gsctl Wheel Package
      run: |
        cd ${GITHUB_WORKSPACE}/python
        python3 setup_gsctl.py bdist_wheel

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      if: false

    - name: Test
      env:
        INTERACTIVE_ADMIN_ENDPOINT: http://localhost:7777
        FLEX_DATA_DIR: ${{ github.workspace }}/flex/interactive/examples/modern_graph
      run: |
        # install gsctl
        python3 -m pip install ${GITHUB_WORKSPACE}/python/dist/*.whl
        # launch service: 8080 for coordinator http port; 7687 for cypher port;
        docker run -p 8080:8080 -p 7687:7687 -p 7777:7777 -p 10000:10000 registry.cn-hongkong.aliyuncs.com/graphscope/interactive:${SHORT_SHA}-x86_64 --enable-coordinator &
        sleep 20
        # test
        python3 -m pip install --no-cache-dir pytest pytest-xdist
        python3 -m pytest -d --tx popen//python=python3 \
                          -s -v \
                          $(dirname $(python3 -c "import graphscope.gsctl as gsctl; print(gsctl.__file__)"))/tests/test_interactive.py
        # test python sdk
        cd ${GITHUB_WORKSPACE}/flex/interactive/sdk/python
        pip3 install -r requirements.txt
        pipe install -r test-requirements.txt
        python3 -m pytest -s -v ./test/test_driver.py
